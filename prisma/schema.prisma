generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//
enum UserStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum PaymentType {
  REGISTER
  EXTEND
  RESTART
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
}

//
// MODELS
//

model Organization {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @map("updated_at")

  // Relations
  users User[]
}

model Role {
  name        String  @id @db.VarChar(100) // PRIMARY KEY
  description String? @db.Text

  users       User[]
  permissions RolePermission[]
}

model Permission {
  name        String  @id @db.VarChar(100) // PRIMARY KEY
  description String? @db.Text

  roles RolePermission[]
}

model RolePermission {
  roleName       String @map("role_name")
  permissionName String @map("permission_name")

  role       Role       @relation(fields: [roleName], references: [name])
  permission Permission @relation(fields: [permissionName], references: [name])

  @@id([roleName, permissionName])
  @@map("role_permissions")
}

model User {
  id             BigInt  @id @default(autoincrement())
  organizationId BigInt? @map("organization_id")
  email          String  @unique @db.VarChar(255)
  password       String  @db.VarChar(255)
  name           String? @db.VarChar(255)

  roleName String @map("role_name") // <── tham chiếu Role.name

  status    UserStatus
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @default(now()) @map("updated_at")

  role              Role               @relation(fields: [roleName], references: [name])
  organization      Organization?      @relation(fields: [organizationId], references: [id])
  payments          Payment[]
  userSubscriptions UserSubscription[]
}

model Subscription {
  id        BigInt   @id @default(autoincrement())
  name      String   @db.VarChar(100) // Basic, Pro, Enterprise
  duration  Int // số ngày sử dụng
  price     Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  payments Payment[]
  userSubs UserSubscription[]
}

model Payment {
  id             BigInt        @id @default(autoincrement())
  userId         BigInt        @map("user_id")
  subscriptionId BigInt?       @map("subscription_id")
  amount         Decimal       @db.Decimal(12, 2)
  paymentType    PaymentType   @map("payment_type")
  paymentDate    DateTime      @default(now()) @map("payment_date")
  status         PaymentStatus @default(PENDING)
  transactionId  String?       @db.VarChar(255)

  // Relations
  user         User               @relation(fields: [userId], references: [id])
  subscription Subscription?      @relation(fields: [subscriptionId], references: [id])
  userSubs     UserSubscription[]
}

model UserSubscription {
  id             BigInt             @id @default(autoincrement())
  userId         BigInt             @map("user_id")
  subscriptionId BigInt             @map("subscription_id")
  paymentId      BigInt?            @map("payment_id")
  startDate      DateTime           @map("start_date")
  endDate        DateTime           @map("end_date")
  status         SubscriptionStatus @default(ACTIVE)
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  payment      Payment?     @relation(fields: [paymentId], references: [id])
}
