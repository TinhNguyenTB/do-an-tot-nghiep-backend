generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  PENDING
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum PaymentType {
  REGISTER
  EXTEND
  RESTART
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
}

//
// MODELS
//

model Organization {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  ownerId     Int      @map("owner_id")
  description String?  @db.Text
  logo        String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  owner User   @relation("OrganizationOwner", fields: [ownerId], references: [id])
  users User[]
  roles Role[]
  permissions Permission[]
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String
  description String? @db.Text

  organizationId Int?
  organization Organization?     @relation(fields: [organizationId], references: [id])

  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  // Many-to-Many
  users       UserRole[]
  permissions RolePermission[]

  // Hierarchical RBAC - Role Inheritance
  inheritsFrom RoleInheritance[] @relation("InheritsFrom")
  inheritedBy  RoleInheritance[] @relation("InheritedBy")
 

  @@unique([organizationId, name]) // role không trùng trong 1 org
}

model Permission {
  id          Int                  @id @default(autoincrement())
  name        String               @unique
  description String?              @db.Text

  organizationId Int?
  organization Organization?     @relation(fields: [organizationId], references: [id])

  endpoints   EndpointPermission[] // Một Permission có thể được dùng cho nhiều endpoint

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  roles RolePermission[]
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model RoleInheritance {
  parentId Int
  childId  Int

  parent Role @relation("InheritedBy", fields: [parentId], references: [id])
  child  Role @relation("InheritsFrom", fields: [childId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([parentId, childId])
  @@map("role_inheritance")
}

model User {
  id             Int     @id @default(autoincrement())
  organizationId Int?    @map("organization_id")
  email          String  @unique @db.VarChar(255)
  password       String  @db.VarChar(255)
  name           String? @db.VarChar(255)
  avatar         String?
  publicId       String?

  status    UserStatus
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  roles               UserRole[]
  organization        Organization?        @relation(fields: [organizationId], references: [id])
  ownedOrganizations  Organization[]       @relation("OrganizationOwner")
  payments            Payment[]
  userSubscriptions   UserSubscription[]
  passwordResetTokens PasswordResetToken[]
}

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([userId, roleId])
  @@map("user_roles")
}

model Subscription {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  duration  Int
  price     Decimal  @db.Decimal(12, 2)
  userLimit Int?     @map("user_limit")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  payments Payment[]
  userSubs UserSubscription[]
}

model Payment {
  id             Int           @id @default(autoincrement())
  userId         Int           @map("user_id")
  subscriptionId Int?          @map("subscription_id")
  amount         Decimal       @db.Decimal(12, 2)
  paymentType    PaymentType   @map("payment_type")
  paymentDate    DateTime      @default(now()) @map("payment_date")
  status         PaymentStatus @default(PENDING)
  transactionId  String?       @db.VarChar(255)

  user         User               @relation(fields: [userId], references: [id])
  subscription Subscription?      @relation(fields: [subscriptionId], references: [id])
  userSubs     UserSubscription[]
}

model UserSubscription {
  id             Int                @id @default(autoincrement())
  userId         Int                @map("user_id")
  subscriptionId Int                @map("subscription_id")
  paymentId      Int?               @map("payment_id")
  startDate      DateTime           @map("start_date")
  endDate        DateTime           @map("end_date")
  status         SubscriptionStatus @default(ACTIVE)
  createdAt      DateTime           @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id])
  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  payment      Payment?     @relation(fields: [paymentId], references: [id])
}

model StripeCustomer {
  id               Int    @id @default(autoincrement())
  customerId       Int    @unique
  stripeCustomerId String @unique

  createdAt DateTime @default(now()) @map("created_at")
}

model EndpointPermission {
  id             Int    @id @default(autoincrement())
  httpMethod     String @map("http_method") @db.VarChar(10) // GET, POST, PATCH, DELETE
  endpoint       String @db.VarChar(255) // Ví dụ: /subscriptions/:id
  permissionName String @map("permission_name")

  permission Permission @relation(fields: [permissionName], references: [name], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Đảm bảo không có hai bản ghi RoutePermission giống nhau (Method + endpoint)
  @@unique([httpMethod, endpoint])
  @@map("endpoint_permissions")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  otpHash   String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
